// REPLACEMENT SECTION FOR index.js
// Replace the section from "// Calculate unique routes" to the end of return statement

        // Calculate total amount sum from flight data
        let totalAmount = 0;
        let currencyCode = 'NOK'; // Default currency
        
        flightData.forEach(record => {
            if (record.Amount && !isNaN(record.Amount)) {
                totalAmount += parseFloat(record.Amount);
            }
            // Get currency from records (should be consistent)
            if (record.Currency && String(record.Currency).trim() !== '') {
                currencyCode = String(record.Currency).trim();
            }
        });
        
        context.log(`ðŸ’° Total amount calculated: ${totalAmount.toFixed(2)} ${currencyCode}`);
        context.log(`ðŸ“ˆ Stats calculated - Airlines: ${airlinesWithPercentages.length}, Destinations: ${allDestinationsWithNames.length}, Total Sum: ${totalAmount.toFixed(2)}`);
        
        return {
            mostUsedAirlines: {
                title: "Mest brukte flyselskap",
                primary: airlinesWithPercentages[0] || { code: 'N/A', name: 'Ingen data', count: 0, percentage: 0 },
                secondary: airlinesWithPercentages.slice(1, 3),
                all: airlinesWithPercentages
            },
            mostVisitedDestination: {
                title: "Mest besÃ¸kte destinasjon",
                destination: allDestinationsWithNames[0] ? {
                    code: allDestinationsWithNames[0].code,
                    name: allDestinationsWithNames[0].name
                } : { code: 'N/A', name: 'Ingen data' },
                count: allDestinationsWithNames[0]?.count || 0,
                all: allDestinationsWithNames
            },
            totalSum: {
                title: "Total Sum",
                value: totalAmount.toFixed(2),
                currency: currencyCode,
                subtitle: `Sum av ${totalFlights.toLocaleString()} flyreiser`,
                formattedValue: `${currencyCode} ${totalAmount.toLocaleString('no-NO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
            }
        };
